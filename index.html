<!DOCTYPE html>
<html lang="en">
    <head>
        <link href="https://bootswatch.com/paper/bootstrap.min.css" rel="stylesheet" type="text/css">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href="main.css" rel="stylesheet" type="text/css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    </head>
    <body>
        <nav class="navbar navbar-default navbar-fixed-top">
            <div class="container-fluid">
                <div class="navbar-header col-md-3" style="padding-left: 0;">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar-collapse-1">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="#"><strong>UofT scheduler</strong></a>
                </div>
                <div class="collapse navbar-collapse" id="bs-navbar-collapse-1">
                    <form class="navbar-form navbar-left" id="griddy-form" role="search" method="get">
                        <div class="form-group">
                            <input type="url" class="form-control griddy-url" name="griddy-url" id="griddy-url" placeholder="Enter a Griddy URL">
                        </div>
                        <button type="submit" class="btn btn-default">submit</button>
                    </form>
                    <ul class="nav navbar-nav navbar-right">
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false" style="height: 64px"><i class="fa fa-cutlery fa-2x"></i></a>
                            <ul class="dropdown-menu" role="menu">
                                <li class="dropdown-header">Food Finder</li>
                                <li class="divider"></li>
                                <li><a href="#"><input type="checkbox"> Show UofT food locations</a></li>
                            </ul>
                        </li>
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false" style="height: 64px"><i class="fa fa-cog fa-2x"></i></a>
                            <ul class="dropdown-menu" role="menu" id="settings">
                                <li class="dropdown-header">Settings</li>

                                <li class="divider"></li>
								<li id="term-F" class="active"><a href="#">Fall</a></li>
								<li id="term-S"><a href="#">Spring</a></li>
                                <li class="divider"></li>
								<li id="day-MONDAY" class="active"><a href="#">Monday</a></li>
								<li id="day-TUESDAY"><a href="#">Tuesday</a></li>
								<li id="day-WEDNESDAY"><a href="#">Wednesday</a></li>
								<li id="day-THURSDAY"><a href="#">Thursday</a></li>
								<li id="day-FRIDAY"><a href="#">Friday</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        <div class="container-fluid body">
            <div class="row" style="height: 100%;">
                <div class="col-md-3 sidebar">
                    <ul class="nav nav-sidebar list-group" id="event-list">
                        <li class="list-group-item event">
                            <h4>MAT135</h4>
                            <p>100 meters, 5 minutes</p>
                        </li>
                        <li class="list-group-item event">
                            <h4>CSC108</h4>
                            <p>50 meters, 3 minutes</p>
                        </li>
                        <li class="list-group-item">
                            <h4>CSC165</h4>
                            <p>203 meters, 6 minutes</p>
                        </li>
                        <li class="list-group-item">
                            <h4>MAT223</h4>
                            <p>70 meters, 8 minutes</p>
                        </li>
                        <li class="list-group-item">
                            <h4>TBB199</h4>
                            <p>200 meters, 1 minutes</p>
                        </li>
                    </ul>
                </div>
				<div class="col-md-9 map">
					<div id="map"></div>
				</div>
            </div>  
        </div>
        <script>
        function secondsToTime(sec) {
            var sec_num = parseInt(sec, 10);
            var hours = Math.floor(sec_num / 3600);
            var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
            // var seconds = sec_num - (hours * 3600) - (minutes * 60);
            var p;
            if (hours < 12) p = "AM";
            else {
                hours -= 12;
                p = "PM";
            }
            if (minutes < 10) minutes = "0" + minutes;
            //if (seconds < 10) seconds = "0" + seconds;
            return hours + (minutes > 0 ? ":" + minutes : "") + " " + p;
        }
		function formatAddress(obj) { return obj.street + ", " + obj.city + " " + obj.province + ", " + obj.country; }
        function addEvents(data) {
			var distanceMatrixService = new google.maps.DistanceMatrixService();
            for (var i = 0; i < data.length; i++) {
                var event = data[i];
				if (i > 0) {
					var prevEvent = data[i-1];
					distanceMatrixService.getDistanceMatrix({
						origins: [formatAddress(prevEvent.section.location.address)],
						destinations: [formatAddress(event.section.location.address)],
						travelMode: "WALKING"
					}, function(response, status) {
						if (status == "OK") {
							var obj = response.rows[0].elements[0];
							addEvent(event, i, obj.distance.text, obj.duration.text);
						}
					});
                } else addEvent(event, i, '0 m', '0 min');
            }
        }
		
		function addEvent(event, index, distance, timeToWalk) {
			$("#event-list").append('<li class="list-group-item event pull-left">' +
				'<h4>' + event.code.slice(0, -3) + '</h4>' + 
				'<p>' + secondsToTime(event.section.start) + ' to ' + secondsToTime(event.section.end) + '<br>' +
                event.section.location.room + " @ <a href='#' id='address-" + index + "'>" + event.section.location.address.street + '</a><br>' + 
				'<span id="distance">' + distance + '</span>, <span id="timeToWalk">' + timeToWalk + '</span>' + '</p></li>');
		}
		
        
		$("#settings li").click(function(e) {
			e.preventDefault();
			var sid = $(this).attr("id").slice(0, -1);
			$("#settings li[id^='" + sid + "'].active").removeClass("active");
			$(this).addClass("active");
		});
        
        $("#griddy-form").submit(function(e) {
            e.preventDefault();
            var url = $("#griddy-url").val();
            var head = "http://griddy.org/?link="
            if (url.indexOf(head) != 0) { alert("Not a valid Griddy URL."); return; }
            var s = url.substring(head.length);
            $.post("api/getcoords", {
				encoded_url: s,
				day: $("li[id^='day-'].active").attr("id").substring(4),
				term: $("li[id^='term-'].active").attr("id").substring(5)
			}, addEvents);
        });
		
var dummyData = [
{
        code: "MAT135H1F",
        name: "Calculus 1(A)",
        section: {
            code: "L0101",
            start: 32400,
            end: 36000,
            location: {
                room: "MP 102",
                address: {
                    street: "255 Huron Street",
                    city: "Toronto",
                    province: "ON",
                    country: "Canada",
                    postal: "M5S 1A7"
                }
            }
        }
    },
    {
        code: "CSC108H1F",
        name: "Introduction to Computer Programming",
        section: {
            code: "L0101",
            start: 36000,
            end: 39600,
            location: {
                room: "WB 116",
                address: {
                    street: "184-200 College Street",
                    city: "Toronto",
                    province: "ON",
                    country: "Canada",
                    postal: "M56 3E5"
                }
            }
        }
    }
];
        $(function() { // debug
            addEvents(dummyData);
        });
		function initMap() {
			// Create a map object and specify the DOM element for display.
			var map = new google.maps.Map($("#map")[0], {
				center: {lat: 43.6629, lng: -79.3957},
				scrollwheel: false,
				zoom: 16
			});
		}
        </script>
		<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD6LFlCi0We4H4xfBkUekkg4Mc10BPIIuw&callback=initMap"></script>
    </body>
</html>